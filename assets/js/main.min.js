/* @preserve Cookie Consent Init */
/*
 * This script is used to display a cookie consent banner.
 * The variables isCookieConsent, cookieName, analyticsName are defined in head.liquid from the _config.yml
 * The variables cookieNotice and cookieNoticeAccept are defined in head.liquid from the _data/translations.yml
 */
function createCookie(name, value, days) {
  var expires = "";
  if (days) {
    var date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = `${name}=${value}${expires}; path=/`;
}

function readCookie(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for (var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

function addCookieConsentListener() {
  document.getElementById('cookie-notice-accept').addEventListener("click", function () {
    createCookie(cookieName, 'true', 31);
    document.getElementById('cookie-notice').style.display = 'none';
    location.reload();
  });
}

function googleAnalytics() {
  if (analyticsName.toLowerCase() !== '') {
    // Google tag manager
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', analyticsName, { 'anonymize_ip': true });
    if (analyticsNameGA4) {
      gtag('config', analyticsNameGA4, { 'anonymize_ip': true });
    }
  }
}

if (isCookieConsent.toLowerCase() === 'true') {
  addCookieConsentListener();
  if (readCookie(cookieName) === 'true') {
    googleAnalytics();
  } else {
    document.getElementById('cookie-notice').style.display = 'block';
  }
} else {
  googleAnalytics();
}


/* @preserve Dark mode Init */
/*
 * There are two colour palettes on CSS for the data-theme: 'light' and 'dark'.
 * Initially the script checks if a theme is set in session storage and
 * alternatively listens to a MediaQuery callback looking for "prefers-color-scheme: dark".
 *
 * The variables darkBtn and lightBtn are defined in head.liquid from the _data/translations.yml
 * The isAutoTheme is defined in head.liquid from the _config.yml
 */

const themeButton = {
    'light': `<i class="fas fa-adjust" aria-hidden="true"></i><span class="navbar-label-with-icon"> ${darkBtn}</span>`,
    'dark': `<i class="fas fa-adjust fa-rotate-180" aria-hidden="true"></i><span class="navbar-label-with-icon"> ${lightBtn}</span>`
};

function currentTheme(){
    return localStorage.getItem('theme');
}

function setMode(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    const toggle = document.getElementById('theme-toggle');
    if (toggle) {
        toggle.innerHTML = themeButton[theme];
    }
}

function themeToggle() {
    let sessionPrefers = currentTheme();
    if (sessionPrefers === 'light') {
        setMode('dark');
    } else {
        setMode('light');
    }
}

function bootstrapTheme() {
    if (isAutoTheme) {
        if (!currentTheme()) {
            // Load browser's preference
            let browserPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            if (browserPrefersDark.matches) localStorage.setItem('theme', 'dark');
            browserPrefersDark.addEventListener('change', () => {
                if (browserPrefersDark.matches) localStorage.setItem('theme', 'dark');
            });
        }
        // Load theme
        let sessionPrefers = currentTheme();
        setMode(sessionPrefers ? sessionPrefers : 'light');
    }
}

// Init
(function () {
    bootstrapTheme();
})()
/* @preserve Masonry Init */
try {
  var elem = document.querySelector('.grid');
  var msnry = new Masonry(elem, {
    itemSelector: '.grid-item',
    columnWidth: '.grid-sizer',
    gutter: '.gutter-sizer',
    percentPosition: true
  });

  // layout Masonry after each image loads
  var imgLoad = imagesLoaded(elem);
  imgLoad.on('progress', function (instance, image) {
    msnry.layout();
  });
} catch (err) {
  if (err instanceof ReferenceError) {
    // Do nothing, Masonry is defined only in the gallery page
  } else {
    throw err;
  }
}
/* @preserve Navbar */
document.addEventListener("DOMContentLoaded", function (event) {

  /*
   * Display the menu items on smaller screens
   */
  const pull = document.getElementById('pull');
  const menu = document.querySelector('nav ul');

  ['click', 'touch'].forEach(function (e) {
    pull?.addEventListener(e, function () {
      menu.classList.toggle('hide')
    }, false);
  });

  /*
   * Make the header images move on scroll
   */
  window.addEventListener('scroll', function () {
    const offset = -(window.scrollY || window.pageYOffset || document.body.scrollTop) / 3;
    const main = document.getElementById('main');
    if (main) {
      main.style.backgroundPosition = '100% ' + (offset - 50) + 'px' + ', 0%, center top';
    }
  });

  /*
   * Fix browser translation: Replace "Both" with "Home" when "Hem" is incorrectly translated
   */
  function fixTranslation() {
    const siteTitle = document.querySelector('.site-title');
    if (siteTitle) {
      const currentText = siteTitle.textContent || siteTitle.innerText || '';
      const trimmed = currentText.trim();
      
      // If the text is "Both" (incorrect translation), replace it with "Home"
      if (trimmed === 'Both' || trimmed.includes('Both')) {
        siteTitle.textContent = 'Home';
        // Also check and replace in innerHTML if needed
        if (siteTitle.innerHTML && siteTitle.innerHTML.includes('Both')) {
          siteTitle.innerHTML = siteTitle.innerHTML.replace(/Both/g, 'Home');
        }
      }
    }
  }

  // Check immediately, after a delay, and periodically
  fixTranslation();
  setTimeout(fixTranslation, 100);
  setTimeout(fixTranslation, 500);
  setTimeout(fixTranslation, 1000);
  setTimeout(fixTranslation, 2000);
  setInterval(fixTranslation, 200);

  // Use MutationObserver to watch for changes made by browser translators
  const siteTitle = document.querySelector('.site-title');
  if (siteTitle) {
    const observer = new MutationObserver(function(mutations) {
      // Use requestAnimationFrame to ensure we check after DOM updates
      requestAnimationFrame(function() {
        fixTranslation();
      });
    });

    observer.observe(siteTitle, {
      childList: true,
      characterData: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['lang', 'translated']
    });
  }

  // Also watch the entire document for translation changes
  const docObserver = new MutationObserver(function(mutations) {
    requestAnimationFrame(function() {
      fixTranslation();
    });
  });

  docObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['lang', 'translated'],
    subtree: true
  });

  // Watch for changes in the document body
  const bodyObserver = new MutationObserver(function(mutations) {
    requestAnimationFrame(function() {
      fixTranslation();
    });
  });

  bodyObserver.observe(document.body, {
    childList: true,
    subtree: true,
    characterData: true
  });
});
